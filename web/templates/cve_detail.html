{% extends "base.html" %}

{% block title %}{{ cve_id }} - APT-ACK{% endblock %}

{% block content %}
<div x-data="cveDetail()" x-init="loadCVE()">
    <div class="mb-6">
        <a href="/" class="text-blue-400 hover:text-blue-300">&larr; Back to Dashboard</a>
    </div>
    
    <template x-if="loading">
        <div class="text-center py-12">
            <div class="text-gray-400">Loading CVE details...</div>
        </div>
    </template>
    
    <template x-if="!loading && cve">
        <div>
            <!-- Header -->
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6">
                <div class="flex items-start justify-between">
                    <div>
                        <h1 class="text-3xl font-bold mb-2" x-text="cve.cve_id"></h1>
                        <div class="flex items-center space-x-4">
                            <span class="px-3 py-1 text-sm font-semibold rounded"
                                  :class="{
                                      'bg-red-900 text-red-200': cve.feed_item?.severity === 'critical',
                                      'bg-orange-900 text-orange-200': cve.feed_item?.severity === 'high',
                                      'bg-yellow-900 text-yellow-200': cve.feed_item?.severity === 'medium'
                                  }"
                                  x-text="cve.feed_item?.severity?.toUpperCase()"></span>
                            <span class="text-sm text-gray-400">
                                First Seen: <span x-text="formatDate(cve.first_seen)"></span>
                            </span>
                            <template x-if="cve.verified">
                                <span class="px-2 py-1 text-xs bg-green-900 text-green-200 rounded">Verified</span>
                            </template>
                        </div>
                    </div>
                    <div class="text-right">
                        <!-- CVSS Score (Primary) -->
                        <template x-if="cve.cvss_v3_score || cve.cvss_v2_score">
                            <div class="mb-4">
                                <div class="text-4xl font-bold"
                                     :class="{
                                         'text-red-400': (cve.cvss_v3_score || cve.cvss_v2_score) >= 9.0,
                                         'text-orange-400': (cve.cvss_v3_score || cve.cvss_v2_score) >= 7.0 && (cve.cvss_v3_score || cve.cvss_v2_score) < 9.0,
                                         'text-yellow-400': (cve.cvss_v3_score || cve.cvss_v2_score) >= 4.0 && (cve.cvss_v3_score || cve.cvss_v2_score) < 7.0,
                                         'text-blue-400': (cve.cvss_v3_score || cve.cvss_v2_score) < 4.0
                                     }"
                                     x-text="(cve.cvss_v3_score || cve.cvss_v2_score).toFixed(1)"></div>
                                <div class="text-sm font-bold uppercase mb-1"
                                     :class="{
                                         'text-red-300': (cve.cvss_v3_severity || cve.cvss_v2_severity) === 'CRITICAL',
                                         'text-orange-300': (cve.cvss_v3_severity || cve.cvss_v2_severity) === 'HIGH',
                                         'text-yellow-300': (cve.cvss_v3_severity || cve.cvss_v2_severity) === 'MEDIUM',
                                         'text-blue-300': (cve.cvss_v3_severity || cve.cvss_v2_severity) === 'LOW'
                                     }"
                                     x-text="(cve.cvss_v3_severity || cve.cvss_v2_severity)"></div>
                                <div class="text-xs text-gray-400" x-text="cve.cvss_v3_score ? 'CVSS v3.x' : 'CVSS v2.0'"></div>
                            </div>
                        </template>

                        <!-- Confidence Score (Secondary) -->
                        <div>
                            <div :class="cve.cvss_v3_score || cve.cvss_v2_score ? 'text-xl' : 'text-3xl'"
                                 class="font-bold text-blue-400"
                                 x-text="cve.confidence.toFixed(2)"></div>
                            <div class="text-sm text-gray-400">Confidence</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Description -->
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6">
                <h2 class="text-xl font-bold mb-4">Description</h2>
                <p class="text-gray-300" x-text="cve.context || 'No description available'"></p>
            </div>

            <!-- CVSS Details -->
            <template x-if="cve.cvss_v3_score || cve.cvss_v2_score">
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6">
                    <h2 class="text-xl font-bold mb-4">CVSS Score Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Score -->
                        <div>
                            <div class="text-sm text-gray-400 mb-2">Base Score</div>
                            <div class="text-3xl font-bold"
                                 :class="{
                                     'text-red-400': (cve.cvss_v3_score || cve.cvss_v2_score) >= 9.0,
                                     'text-orange-400': (cve.cvss_v3_score || cve.cvss_v2_score) >= 7.0 && (cve.cvss_v3_score || cve.cvss_v2_score) < 9.0,
                                     'text-yellow-400': (cve.cvss_v3_score || cve.cvss_v2_score) >= 4.0 && (cve.cvss_v3_score || cve.cvss_v2_score) < 7.0,
                                     'text-blue-400': (cve.cvss_v3_score || cve.cvss_v2_score) < 4.0
                                 }"
                                 x-text="(cve.cvss_v3_score || cve.cvss_v2_score).toFixed(1)"></div>
                            <div class="text-xs text-gray-400 mt-1">out of 10.0</div>
                        </div>

                        <!-- Severity -->
                        <div>
                            <div class="text-sm text-gray-400 mb-2">Severity Rating</div>
                            <div class="text-2xl font-bold"
                                 :class="{
                                     'text-red-400': (cve.cvss_v3_severity || cve.cvss_v2_severity) === 'CRITICAL',
                                     'text-orange-400': (cve.cvss_v3_severity || cve.cvss_v2_severity) === 'HIGH',
                                     'text-yellow-400': (cve.cvss_v3_severity || cve.cvss_v2_severity) === 'MEDIUM',
                                     'text-blue-400': (cve.cvss_v3_severity || cve.cvss_v2_severity) === 'LOW'
                                 }"
                                 x-text="(cve.cvss_v3_severity || cve.cvss_v2_severity)"></div>
                            <div class="text-xs text-gray-400 mt-1">NVD Assessment</div>
                        </div>

                        <!-- Vector -->
                        <template x-if="cve.cvss_v3_vector">
                            <div>
                                <div class="text-sm text-gray-400 mb-2">Vector String</div>
                                <div class="font-mono text-sm text-gray-300 break-all" x-text="cve.cvss_v3_vector"></div>
                                <a :href="'https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=' + cve.cvss_v3_vector"
                                   target="_blank"
                                   class="text-xs text-blue-400 hover:text-blue-300 mt-2 inline-block">
                                    View in CVSS Calculator â†’
                                </a>
                            </div>
                        </template>
                    </div>

                    <!-- CVSS Explanation -->
                    <div class="mt-4 p-4 bg-gray-900 rounded border border-gray-700">
                        <div class="text-sm text-gray-400">
                            <strong>About CVSS:</strong> The Common Vulnerability Scoring System (CVSS) provides an objective, standardized method for rating the severity of security vulnerabilities.
                            Scores range from 0.0 to 10.0, with higher scores indicating greater severity.
                        </div>
                    </div>
                </div>
            </template>

            <!-- Details Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- CWE Information -->
                <template x-if="cve.cwe_ids">
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                        <h3 class="text-lg font-bold mb-3">Weakness Classification</h3>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="cwe in cve.cwe_ids.split(', ')" :key="cwe">
                                <a :href="'https://cwe.mitre.org/data/definitions/' + cwe.split('-')[1] + '.html'" 
                                   target="_blank"
                                   class="px-3 py-1 bg-purple-900 text-purple-200 rounded text-sm hover:bg-purple-800">
                                    <span x-text="cwe"></span>
                                </a>
                            </template>
                        </div>
                    </div>
                </template>
                
                <!-- Threat Attribution -->
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-lg font-bold mb-3">Threat Attribution</h3>
                    <div class="space-y-2">
                        <template x-if="cve.threat_actor">
                            <div>
                                <span class="text-gray-400">Threat Actor:</span>
                                <span class="ml-2 text-red-400 font-semibold" x-text="cve.threat_actor"></span>
                            </div>
                        </template>
                        <template x-if="cve.malware_family">
                            <div>
                                <span class="text-gray-400">Malware Family:</span>
                                <span class="ml-2 text-orange-400 font-semibold" x-text="cve.malware_family"></span>
                            </div>
                        </template>
                        <template x-if="!cve.threat_actor && !cve.malware_family">
                            <div class="text-gray-500">No attribution data available</div>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Tags -->
            <template x-if="cve.tags && cve.tags.length > 0">
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6">
                    <h3 class="text-lg font-bold mb-3">Tags</h3>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="tag in cve.tags" :key="tag.name">
                            <span class="px-3 py-1 text-sm bg-gray-700 text-gray-300 rounded">
                                <span x-text="tag.name"></span>
                                <span class="ml-1 text-gray-500" x-text="'(' + tag.category + ')'"></span>
                            </span>
                        </template>
                    </div>
                </div>
            </template>
            
            <!-- Source Feed Item -->
            <template x-if="cve.feed_item">
                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                    <h3 class="text-lg font-bold mb-3">Source Intelligence</h3>
                    <div class="space-y-2">
                        <div>
                            <span class="text-gray-400">Source:</span>
                            <span class="ml-2 text-blue-400" x-text="cve.feed_item.source"></span>
                        </div>
                        <div>
                            <span class="text-gray-400">Title:</span>
                            <a :href="cve.feed_item.link" 
                               target="_blank"
                               class="ml-2 text-blue-400 hover:text-blue-300" 
                               x-text="cve.feed_item.title"></a>
                        </div>
                    </div>
                </div>
            </template>
            
            <!-- External Links -->
            <div class="mt-6 flex space-x-4">
                <a :href="'https://nvd.nist.gov/vuln/detail/' + cve.cve_id" 
                   target="_blank"
                   class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white">
                    View on NVD
                </a>
                <a :href="'https://cve.mitre.org/cgi-bin/cvename.cgi?name=' + cve.cve_id" 
                   target="_blank"
                   class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded">
                    View on MITRE
                </a>
            </div>
        </div>
    </template>
    
    <template x-if="!loading && error">
        <div class="bg-red-900 border border-red-700 p-6 rounded-lg text-center">
            <div class="text-red-200" x-text="error"></div>
        </div>
    </template>
</div>

<script>
function cveDetail() {
    return {
        cve: null,
        loading: true,
        error: null,
        
        async loadCVE() {
            const cveId = window.location.pathname.split('/').pop();
            try {
                const response = await fetch(`/api/cve/${cveId}`);
                if (!response.ok) {
                    throw new Error('CVE not found');
                }
                this.cve = await response.json();
            } catch (err) {
                this.error = err.message;
            } finally {
                this.loading = false;
            }
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    }
}
</script>
{% endblock %}