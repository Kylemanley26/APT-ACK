{% extends "base.html" %}

{% block title %}Timeline - APT-ACK{% endblock %}

{% block content %}
<div x-data="timeline()" x-init="loadTimeline()">
    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 mb-6">
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold">Threat Intelligence Timeline</h1>
            <div>
                <label class="text-sm text-gray-400 mr-2">Timeframe:</label>
                <select x-model="days" @change="loadTimeline()" class="bg-gray-700 border border-gray-600 rounded px-3 py-2">
                    <option value="7">Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="60">Last 60 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>
        </div>
        
        <div class="h-96">
            <canvas id="timelineChart"></canvas>
        </div>
    </div>
    
    <!-- Severity Distribution -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h2 class="text-xl font-bold mb-4">Daily Activity</h2>
            <div class="space-y-3">
                <template x-for="(data, date) in sortedTimeline" :key="date">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400" x-text="formatDate(date)"></span>
                            <span class="text-gray-300 font-semibold" x-text="getTotalForDate(data) + ' items'"></span>
                        </div>
                        <div class="flex h-6 rounded overflow-hidden">
                            <template x-if="data.critical">
                                <div class="bg-red-600 flex items-center justify-center text-xs text-white"
                                     :style="'width: ' + (data.critical / getTotalForDate(data) * 100) + '%'"
                                     x-text="data.critical"></div>
                            </template>
                            <template x-if="data.high">
                                <div class="bg-orange-600 flex items-center justify-center text-xs text-white"
                                     :style="'width: ' + (data.high / getTotalForDate(data) * 100) + '%'"
                                     x-text="data.high"></div>
                            </template>
                            <template x-if="data.medium">
                                <div class="bg-yellow-600 flex items-center justify-center text-xs text-white"
                                     :style="'width: ' + (data.medium / getTotalForDate(data) * 100) + '%'"
                                     x-text="data.medium"></div>
                            </template>
                            <template x-if="data.low">
                                <div class="bg-blue-600 flex items-center justify-center text-xs text-white"
                                     :style="'width: ' + (data.low / getTotalForDate(data) * 100) + '%'"
                                     x-text="data.low"></div>
                            </template>
                            <template x-if="data.info">
                                <div class="bg-gray-600 flex items-center justify-center text-xs text-white"
                                     :style="'width: ' + (data.info / getTotalForDate(data) * 100) + '%'"
                                     x-text="data.info"></div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <h2 class="text-xl font-bold mb-4">Period Summary</h2>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Critical</span>
                        <span class="text-2xl font-bold text-red-500" x-text="summary.critical"></span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">High</span>
                        <span class="text-2xl font-bold text-orange-500" x-text="summary.high"></span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Medium</span>
                        <span class="text-2xl font-bold text-yellow-500" x-text="summary.medium"></span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Low</span>
                        <span class="text-2xl font-bold text-blue-500" x-text="summary.low"></span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Info</span>
                        <span class="text-2xl font-bold text-gray-500" x-text="summary.info"></span>
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300 font-semibold">Total</span>
                        <span class="text-3xl font-bold text-blue-400" x-text="summary.total"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function timeline() {
    return {
        days: 30,
        timelineData: {},
        chart: null,
        
        get sortedTimeline() {
            return Object.entries(this.timelineData)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .reduce((obj, [key, val]) => ({ ...obj, [key]: val }), {});
        },
        
        get summary() {
            const summary = {
                critical: 0,
                high: 0,
                medium: 0,
                low: 0,
                info: 0,
                total: 0
            };
            
            Object.values(this.timelineData).forEach(data => {
                summary.critical += data.critical || 0;
                summary.high += data.high || 0;
                summary.medium += data.medium || 0;
                summary.low += data.low || 0;
                summary.info += data.info || 0;
            });
            
            summary.total = summary.critical + summary.high + summary.medium + summary.low + summary.info;
            return summary;
        },
        
        async loadTimeline() {
            const response = await fetch(`/api/timeline?days=${this.days}`);
            this.timelineData = await response.json();
            this.renderChart();
        },
        
        renderChart() {
            const ctx = document.getElementById('timelineChart');
            
            if (this.chart) {
                this.chart.destroy();
            }
            
            const dates = Object.keys(this.timelineData).sort();
            const datasets = [
                {
                    label: 'Critical',
                    data: dates.map(date => this.timelineData[date].critical || 0),
                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                    borderColor: 'rgb(239, 68, 68)',
                    borderWidth: 2
                },
                {
                    label: 'High',
                    data: dates.map(date => this.timelineData[date].high || 0),
                    backgroundColor: 'rgba(249, 115, 22, 0.8)',
                    borderColor: 'rgb(249, 115, 22)',
                    borderWidth: 2
                },
                {
                    label: 'Medium',
                    data: dates.map(date => this.timelineData[date].medium || 0),
                    backgroundColor: 'rgba(234, 179, 8, 0.8)',
                    borderColor: 'rgb(234, 179, 8)',
                    borderWidth: 2
                },
                {
                    label: 'Low',
                    data: dates.map(date => this.timelineData[date].low || 0),
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    borderColor: 'rgb(255, 255, 255)',
                    borderWidth: 2
                },
                {
                    label: 'Info',
                    data: dates.map(date => this.timelineData[date].info || 0),
                    backgroundColor: 'rgba(107, 114, 128, 0.8)',
                    borderColor: 'rgb(107, 114, 128)',
                    borderWidth: 2
                }
            ];
            
            this.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: { color: 'rgba(75, 85, 99, 0.3)' },
                            ticks: { color: 'rgb(156, 163, 175)' }
                        },
                        y: {
                            stacked: true,
                            grid: { color: 'rgba(75, 85, 99, 0.3)' },
                            ticks: { color: 'rgb(156, 163, 175)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'rgb(229, 231, 235)' }
                        }
                    }
                }
            });
        },
        
        getTotalForDate(data) {
            return (data.critical || 0) + (data.high || 0) + (data.medium || 0) + 
                   (data.low || 0) + (data.info || 0);
        },
        
        formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }
    }
}
</script>
{% endblock %}